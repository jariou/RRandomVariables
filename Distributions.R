a <-
c(0.824848220711877, 0.449040119569514, 0.629053446970699, 0.475095778346057, 
0.891534368610663, 0.918798438214527, 0.67053669933778, 0.390442235153488, 
0.0509188047411831, 0.445209404710991, 0.796538373659894, 0.00236462716221335, 
0.633992275739513, 0.98116032118023, 0.837796598918158, 0.813337697659465, 
0.878576501162094, 0.977450732497498, 0.0168003020265293, 0.611008281132271, 
0.502707273000905, 0.34366417377317, 0.665657636398963, 0.874637359702117, 
0.584108303484222, 0.087207606599643, 0.904118263764487, 0.965686355304393, 
0.928389793266082, 0.416267041183478, 0.252431805074716, 0.0872191027975429, 
0.00896256197742836, 0.429161345912909, 0.961298241618405, 0.833417328163764, 
0.607861982939218, 0.0293685318872412, 0.84315073471182, 0.689723348984869, 
0.720792320704687, 0.919059452852678, 0.743979400757325, 0.399759227173588, 
0.556528047052113, 0.193340960058432, 0.394332445708332, 0.950211205157885, 
0.880787899610941, 0.569805131824229, 0.876015207072763, 0.520030470091967, 
0.624546072951843, 0.340723996731783, 0.781545745585048, 0.167370561479006, 
0.754396270877247, 0.201125774447699, 0.654755265353714, 0.453867549090462, 
0.472817038447466, 0.915968003511457, 0.457694351946879, 0.380625782161805, 
0.603812451931162, 0.579850679105568, 0.632730607454132, 0.136019239445419, 
0.138041451287112, 0.142690408243505, 0.787665489600584, 0.133410384638681, 
0.99341121068793, 0.936405780606372, 0.934935481936969, 0.0579548632156238, 
0.522155913871079, 0.0632551663705085, 0.430785983149879, 0.985669691631467, 
0.226789552500966, 0.102076839745532, 0.335595582510248, 0.405381505903922, 
0.643540102927812, 0.150156958046999, 0.490246165813889, 0.510503074594048, 
0.0670121973794302, 0.0630485568987238, 0.491191378605803, 0.798447984812219, 
0.947473983811144, 0.542532596357034, 0.35682528230755, 0.351176789257792, 
0.894398776565562, 0.992065332532934, 0.450587444188696, 0.0848071156892981, 
0.787893776329442, 0.28934863802457, 0.328082957458595, 0.0131302037930274, 
0.333800967546888, 0.647685286003174, 0.895760095418378, 0.480534735681372, 
0.976898115737312, 0.173982368163749, 0.862745171669903, 0.766015793154515, 
0.754707207309556, 0.843133658221263, 0.607785264757804, 0.721892482633117, 
0.367359320581088, 0.741045681187861, 0.0770353135266442, 0.760921378914765, 
0.725928787254192, 0.257253988649334, 0.987459951363218, 0.815196231464573, 
0.866964795165464, 0.102395183326277, 0.564031173168965, 0.00416525723592646, 
0.175676848325089, 0.458923757641371, 0.264540745408327, 0.384844316564361, 
0.279412340577534, 0.593718458473837, 0.0399844466249476, 0.681597287389421, 
0.672779521782635, 0.489080848916185, 0.421887351234191, 0.186545490217728, 
0.380469080976593, 0.564356410584339, 0.767211703977337, 0.338818031702555, 
0.330115053933353, 0.476214833507021, 0.726594827388445, 0.585181737658122, 
0.284990807872824, 0.830259198516933, 0.497460643386565, 0.0883366699218012, 
0.0891144914653315, 0.136094204330532, 0.916214150933736, 0.548767665353299, 
0.944078761183955, 0.554055959700578, 0.804325076400142, 0.761185621318748, 
0.686065096823324, 0.749569938775872, 0.0770159401476403, 0.690238549475864, 
0.755230441524312, 0.589042121047549, 0.947029223166101, 0.470462978183524, 
0.0209887197022509, 0.432658445187004, 0.207443897827248, 0.475721754162313, 
0.992451777931927, 0.964258092391586, 0.0452767309298865, 0.254339353482121, 
0.435548029933622, 0.537645479363725, 0.161157505651126, 0.78428396341586, 
0.689229491195893, 0.961245025205381, 0.520923051741153, 0.653375612935438, 
0.67389190433943, 0.232152686068136, 0.823821573421655, 0.816918275137228, 
0.0805808230709003, 0.137779404311299, 0.282796521801846, 0.725111708507276, 
0.246353548312446, 0.169368397525846, 0.634921153094763, 0.0312575346351235, 
0.502204451643627, 0.442671897086547, 0.835620959794634, 0.41607772874517, 
0.910794147158622, 0.00936093618112477, 0.600496937095599, 0.452985547753779, 
0.724764843086107, 0.86431623063606, 0.827789639926134, 0.896185865576759, 
0.593738598352, 0.223770632161297, 0.194321932906505, 0.380303810109915, 
0.817705285129154, 0.842647441609197, 0.593190807769235, 0.291927349839682, 
0.26851142036349, 0.656349997856798, 0.181658432861242, 0.394863108335401, 
0.696454477088086, 0.17344464483951, 0.629162147741028, 0.724226978140162, 
0.975416502200315, 0.886055502388421, 0.285034068572805, 0.716428671455493, 
0.922561699913143, 0.747509872145118, 0.0914525962656028, 0.665930104068903, 
0.521339418901893, 0.976610147336727, 0.760111190204281, 0.0699713320897224, 
0.447203873464535, 0.168123066221303, 0.789567852340256, 0.901297819273891, 
0.648944357340644, 0.283281626715762, 0.837755439198504, 0.449513447446418, 
0.963388373560171, 0.951076101856702, 0.967569029290813, 0.0924139390922234, 
0.326744410345395, 0.140348072650594, 0.758143974203316, 0.920587858264228, 
0.555289821240076, 0.416558174554007, 0.68071249777644, 0.848844046315627, 
0.0823425355774314, 0.42169077820353, 0.49154197085639, 0.0898917088095158, 
0.605389881611906, 0.320293390338463, 0.889742973717237, 0.586793886594544, 
0.903569676004357, 0.25278296222458, 0.486476529192278, 0.757331288460755, 
0.531669876926254, 0.693188832637907, 0.451592746720806, 0.522994366528366, 
0.704626037788119, 0.398759074442452, 0.378890901983682, 0.607459186364822, 
0.484334381401776, 0.760044363863244, 0.365269668300609, 0.494263359303457, 
0.65621670932967, 0.10117169618047, 0.404008386059052, 0.309810209815182, 
0.999932782823673, 0.94691410201384, 0.00754839417981508, 0.987898681694398, 
0.244763396151625, 0.393180116547103, 0.579246717215418, 0.244603225145967, 
0.412858799143872, 0.818666130195545, 0.765981843591282, 0.867977890798812, 
0.699124692053367, 0.882162023813296, 0.0375418737478414, 0.273968250632093, 
0.128130498116434, 0.796084141282009, 0.402182898881288, 0.137934367328187, 
0.672958695736087, 0.61776876860822, 0.779666284779367, 0.315840959788789, 
0.0534909260645439, 0.236188571502184, 0.161326902950275, 0.853726037916927, 
0.512556793719154, 0.838289854236727, 0.659235669111523, 0.781461997309669, 
0.985558495950118, 0.857431856799531, 0.359397226561691, 0.137535903931989, 
0.421352343874526, 0.901823906164826, 0.0690677560120795, 0.217036457204488, 
0.269223758700542, 0.145424191007361, 0.0925131678840632, 0.94089986450068, 
0.762577364830215, 0.727020364448207, 0.91736957011192, 0.95985847657297, 
0.751242207835407, 0.498607259254903, 0.779331642371533, 0.356813628364, 
0.984183103832475, 0.73931714238953, 0.139364142277659, 0.072901764364655, 
0.298374311030596, 0.823103118445793, 0.676038195060524, 0.556881959480759, 
0.962252829537192, 0.524354657111001, 0.818488555808596, 0.88041455372278, 
0.48613169344332, 0.138285256649019, 0.859535868382573, 0.702693445603662, 
0.483451237490849, 0.00815834897213683, 0.476385951247689, 0.0860763238673695, 
0.572693037577853, 0.539287823278623, 0.988631790726325, 0.0658183634521684, 
0.0183838612235462, 0.183924942865895, 0.367631560487165, 0.971214361942461, 
0.325541320102033, 0.397379945658531, 0.98907310265901, 0.595544595222341, 
0.509150960873569, 0.417667870331366, 0.673548729208671, 0.874888636254303, 
0.298478227005286, 0.11900188123199, 0.910777233719403, 0.35684450306701, 
0.182652555441241, 0.599570838654728, 0.868756223015892, 0.58050610916947, 
0.0695396103739273, 0.4071541345945, 0.154369412750441, 0.821417813839112, 
0.840430265025316, 0.838810729808161, 0.965599538190657, 0.394971843983004, 
0.704698215205765, 0.781530743376996, 0.929573281227095, 0.674971051144273, 
0.705375276966793, 0.358418726848895, 0.79003817743531, 0.651285704419839, 
0.67103729354772, 0.0490985185555672, 0.25481253598989, 0.254909961943661, 
0.383469817716091, 0.106442487590165, 0.717019911435393, 0.578293468385608, 
0.0560920482157656, 0.387307243938981, 0.791056658828858, 0.492081850934205, 
0.679685493234449, 0.15592260485159, 0.0203931044474353, 0.310433830794891, 
0.06060284814457, 0.741695816288424, 0.167155828244258, 0.614788135571486, 
0.167182399432991, 0.676739470500373, 0.0993074886559588, 0.901681491716948, 
0.00907344397140734, 0.790626483713005, 0.943035240439353, 0.840967134197669, 
0.192069161884801, 0.906637091793026, 0.0415640923123854, 0.706443932044643, 
0.320344489486739, 0.223491518400821, 0.829317648220516, 0.271840125130876, 
0.636496549954571, 0.89546677859889, 0.0105008359003108, 0.203254238572789, 
0.152953640304097, 0.923952889437395, 0.845649080853703, 0.957777267093209, 
0.0811581734379949, 0.693027027990455, 0.00972284108047405, 0.85428097285023, 
0.650563508191397, 0.138493236704352, 0.669492288314753, 0.322735615404117, 
0.903787940568944, 0.463932346994607, 0.153615991382145, 0.455071519619247, 
0.845011923274918, 0.632094705817207, 0.0576010946108343, 0.451354038459381, 
0.593313786756774, 0.385327340120714, 0.930457545088656, 0.430845962191748, 
0.889041925292584, 0.114177867217435, 0.44687571412508, 0.908250787096609, 
0.567250072153811, 0.148609479085161, 0.215221063240187, 0.954905593904671, 
0.117582878303895, 0.286858246180955, 0.102886110174048, 0.407384247418048, 
0.482447219420206, 0.608278972242198, 0.293047645128148, 0.0664276759807192, 
0.535504869978417, 0.588583148532271, 0.654910431516202, 0.497613245262123, 
0.0480721630092109, 0.30953085356241, 0.231734494237849, 0.26592481936547, 
0.140784998038053, 0.741688711294335, 0.480935424715772, 0.594995298362083, 
0.815628699040356, 0.402678348973628, 0.450109270074157, 0.0336842759392953, 
0.356963238258772, 0.129153422151881, 0.77808288517551, 0.835729081002337, 
0.450465313304928, 0.738157293662652, 0.587839067461767, 0.648969842997971, 
0.376454606684101, 0.637509158019168, 0.431537675247762, 0.756503145656633, 
0.311852079996196, 0.705520859194619, 0.310620201842482, 0.825544097487197, 
0.541018180716123, 0.33722559530129, 0.606303575219342, 0.848299706846471, 
0.59704582359809, 0.0525435007247823, 0.901374641553677, 0.62896880309969, 
0.639337841453132, 0.274567998902189, 0.565889303837627, 0.00524674869580239, 
0.931528884698936, 0.899873502059349, 0.599489693400632, 0.488049483170296, 
0.863268590945526, 0.573411594188592, 0.891830570026575, 0.360059519663163, 
0.921070937298082, 0.699341905923559, 0.430245700720616, 0.485838607111471, 
0.47914088862194, 0.669016800735837, 0.611691584324096, 0.6651894165235, 
0.355087645365335, 0.130543640649175, 0.29242163631521, 0.663916248424975, 
0.4346171092466, 0.472445201153117, 0.322503293922788, 0.776795987978325, 
0.0774115165739346, 0.664786666332164, 0.176512114216721, 0.815243026886324, 
0.864704948241117, 0.946325543964378, 0.327206926934607, 0.910003631504603, 
0.875588374962576, 0.773290177463263, 0.961933753878907, 0.766737841506797, 
0.984640819260293, 0.0694492035266503, 0.570625385872085, 0.440046087103434, 
0.407009958008173, 0.286910328768375, 0.724995412787321, 0.0738255690595221, 
0.0697538600487073, 0.668051563355903, 0.918545842030272, 0.250799614684903, 
0.414803194812316, 0.828709708062933, 0.424684055874293, 0.0124381056676159, 
0.0183962361708118, 0.706438413284584, 0.808687321894953, 0.284266110164562, 
0.424350646932972, 0.00906599512655573, 0.927281647621136, 0.205376682142186, 
0.0684029720817427, 0.990084334319856, 0.304039548887079, 0.332690409319794, 
0.917222828003138, 0.748213781806736, 0.815790704419267, 0.869134352727262, 
0.356262991936939, 0.533590062058078, 0.64007895379998, 0.431870659439111, 
0.37005733271052, 0.741484392421873, 0.659419510057976, 0.438354163201051, 
0.165702691650489, 0.898100013869255, 0.15640219092873, 0.456201313595157, 
0.140799146548823, 0.427368822710477, 0.244495952019884, 0.335067574574767, 
0.990680082567646, 0.860605403060132, 0.394110182967134, 0.863660895986881, 
0.795192279867217, 0.653326669107642, 0.732352384219166, 0.733623638913125, 
0.186318441485454, 0.692256401747101, 0.259265132954374, 0.375780867430564, 
0.436780236862181, 0.290071982483708, 0.786537214493227, 0.511779673030451, 
0.932237630445696, 0.314541916199179, 0.934185654044984, 0.416819159943473, 
0.106581143667158, 0.149967254499985, 0.536395947949721, 0.737410447165468, 
0.57445532163838, 0.308525777493886, 0.992716028189128, 0.271687858558523, 
0.421055959359271, 0.2805216140505, 0.813121980923022, 0.237090305244008, 
0.159111332159141, 0.90810000968407, 0.531282899137369, 0.517560569000459, 
0.397688255110356, 0.158063271717707, 0.874566516123632, 0.584955150089897, 
0.454555433146494, 0.0451062925528901, 0.689167680250618, 0.896381975313124, 
0.662096352037835, 0.48541303804921, 0.748664949054789, 0.215014080110487, 
0.458458046461215, 0.937245412095798, 0.867609336813024, 0.518770336781334, 
0.756445585142789, 0.534935807602219, 0.357897175836988, 0.303678503797695, 
0.0546059488519429, 0.246789307087738, 0.508477785232978, 0.0804330993086878, 
0.887639983157096, 0.486115958582122, 0.956356860207787, 0.159588487809773, 
0.0239226960142659, 0.57603064244134, 0.455125454954201, 0.700080604890338, 
0.673920846413412, 0.998382004453533, 0.951963599439928, 0.463336226826148, 
0.875709517453821, 0.943309180935504, 0.292744693404947, 0.244159065148602, 
0.761972883347007, 0.130908919988812, 0.216368927623472, 0.829878448743391, 
0.72561177825979, 0.512222579224456, 0.955992728390175, 0.153073119060745, 
0.796795631688543, 0.0181730176103264, 0.335599384277853, 0.143165879207213, 
0.449207425007769, 0.878050604969976, 0.915911725935498, 0.421857282620083, 
0.183175444952274, 0.452716098288812, 0.0676745736579835, 0.369508931041602, 
0.59992115683957, 0.395823045235126, 0.680629933538112, 0.282371730009556, 
0.0598640708383587, 0.905011157411807, 0.880489474128022, 0.820247153572699, 
0.267087362764446, 0.0718089796152288, 0.372191472374121, 0.550984442749692, 
0.530722983002559, 0.590503198216016, 0.369007079283298, 0.458688603421445, 
0.611828200850769, 0.444377289098641, 0.539039979946201, 0.425508548043954, 
0.214719249626288, 0.664872478654821, 0.395099114667941, 0.0719764073767732, 
0.499189373066172, 0.431000709065466, 0.422227190165518, 0.562278534451851, 
0.0292023977937429, 0.803754582083974, 0.0522729849199725, 0.577394738790637, 
0.610043560747202, 0.298357608852699, 0.0868301345054599, 0.501302241747111, 
0.0120961547665221, 0.981998916771144, 0.951517648466417, 0.0506161894220483, 
0.801506857764596, 0.499969013091122, 0.450845963335392, 0.822138294573324, 
0.582450134572413, 0.177283882852661, 0.207121331207238, 0.786152903199246, 
0.73293698151469, 0.207108321781103, 0.228711359156806, 0.760812263072725, 
0.794051111109023, 0.309895826947143, 0.562088854717761, 0.447985927898374, 
0.124133052763863, 0.948985800386631, 0.415864301831257, 0.74378540162141, 
0.397799914712453, 0.496185696611881, 0.176630791570623, 0.204575170071226, 
0.560675441280925, 0.767688704059504, 0.274955248490309, 0.187866256827899, 
0.805155689081622, 0.0399940293632201, 0.941655278624447, 0.0576353199144361, 
0.276907517905957, 0.405719639806201, 0.648324136336617, 0.436408435277701, 
0.604658197528866, 0.353427632667609, 0.283980489045338, 0.716696261565045, 
0.709957516091906, 0.490176173445068, 0.295630452174662, 0.71963990039912, 
0.222708525392766, 0.302879095332179, 0.0834165722707566, 0.231496836505084, 
0.426412901892139, 0.37843144680786, 0.464613593782297, 0.659171383276684, 
0.519145753545117, 0.0786350462495384, 0.0267923369312517, 0.347318818071986, 
0.39602249192995, 0.818594304166483, 0.201486204655391, 0.358446090768886, 
0.89382668480422, 0.205615541966908, 0.691714702150694, 0.0193011063702055, 
0.629726488522395, 0.0783858003549041, 0.520913183921774, 0.754210066734664, 
0.859586629133276, 0.321679774799463, 0.115291648252126, 0.646862522017057, 
0.712046502779577, 0.977956255802807, 0.927712703688265, 0.0511427525252962, 
0.655343205334338, 0.247066446236508, 0.229054575750469, 0.965366103058073, 
0.868650615659645, 0.660937015367592, 0.0935152541276626, 0.585508220782871, 
0.6764162857333, 0.173106787459096, 0.913855915803382, 0.0576337316668201, 
0.714903691322913, 0.890259885863009, 0.782163646379546, 0.186092552536228, 
0.183310650571121, 0.100201639989358, 0.00715410173762302, 0.931231824605915, 
0.778622826385174, 0.0375059263685883, 0.639219874505781, 0.689007899355912, 
0.852373739898901, 0.246750056988175, 0.512982895843312, 0.623200182035433, 
0.697073296930386, 0.648644139844549, 0.402527825907781, 0.114227544821765, 
0.737994892466121, 0.343208192371863, 0.597801649549783, 0.22252926900955, 
0.235257297684453, 0.0148212494243987, 0.130791190844229, 0.0371884278890017, 
0.0033962258882089, 0.134492220233693, 0.704494745208136, 0.249927351023893, 
0.262226478013862, 0.815334766507342, 0.696588026260207, 0.0663130020124607, 
0.968692710266854, 0.969644258068496, 0.662272060090057, 0.711028522729021, 
0.229351415038033, 0.978004499606946, 0.778114463440089, 0.0103440971190461, 
0.235895915489492, 0.0484380889641732, 0.187574306066883, 0.414623644126943, 
0.986156587842782, 0.938679192660338, 0.933856559765601, 0.063752397045514, 
0.294231832540742, 0.909342336243389, 0.779871456336064, 0.888826775287568, 
0.0218333562083872, 0.593544247634061, 0.90940766713182, 0.944172250423901, 
0.49379140620463, 0.350653216362872, 0.534282283849165, 0.935665231842584, 
0.987372695625773, 0.307571895624344, 0.934841312118495, 0.140462842609202, 
0.267630444899476, 0.727413134902549, 0.364349232770102, 0.00571005268035574, 
0.861566367863164, 0.0232311927214024, 0.579976138577844, 0.762412762259024, 
0.431845502449509, 0.883096976842115, 0.858449452567072, 0.557759146361396, 
0.30738881742936, 0.542008998906747, 0.24442642091857, 0.141118125806382, 
0.768823676880875, 0.478401655645491, 0.00658599454375925, 0.738914188548308, 
0.819673327877403, 0.273636242236946, 0.0296144613525337, 0.677978483195043, 
0.28950985487828, 0.17710512955048, 0.828946784844453, 0.796309870823784, 
0.961410009582462, 0.40659651626264, 0.614318600141347, 0.888630477536034, 
0.169109660357754, 0.48550597818486, 0.0276276222553362, 0.61190197074423, 
0.159228385782438, 0.767601032680499, 0.506222182133499, 0.330213841082904, 
0.702891398920535, 0.905066147231693, 0.0166918968011129, 0.586294573517306, 
0.22844521126793, 0.254149262233325, 0.947332479248662, 0.154440561336926, 
0.644332210104196, 0.63019622599604, 0.809481558711514, 0.364702158533843, 
0.63703209122825, 0.683794792901412, 0.82805404126746, 0.686139315412134, 
0.785302133637985, 0.11034499831503, 0.583464604081811, 0.472428668956314, 
0.479097480409503, 0.809427865076389, 0.480545876548756, 0.970256020260065, 
0.0635450037027706, 0.113915933552827, 0.186522863243035, 0.598490038461036, 
0.194879418802652, 0.246465526765865, 0.992097141470412, 0.585943113811976, 
0.78129142941116, 0.868067148577301, 0.243388346618361, 0.639045742115507, 
0.585620619496161, 0.674405156454896, 0.307234687384601, 0.830511601400201, 
0.449159918196506, 0.636969092273872, 0.207942881790473, 0.380718270647076, 
0.431673513830705, 0.996841904519934, 0.951312414563004, 0.121627145748303, 
0.857156963378974, 0.325761477034863, 0.906402158684713, 0.23225439826947, 
0.826801055038079, 0.0854096758492836, 0.303220345704107, 0.938166041675185, 
0.38792970799718, 0.722877127836786, 0.0309765393935972, 0.10717036838872, 
0.0826277220720668, 0.269527323223349, 0.241993249192239, 0.764333306913924, 
0.690208904802945, 0.0849071256269402, 0.646649997225801, 0.0654013059078776, 
0.758853919727343, 0.175007627381144, 0.943855159431662, 0.541307395027787, 
0.0429292510600399, 0.990184933308144, 0.0987001383491215, 0.596201668898106, 
0.375877519300085, 0.141920479675746, 0.628602075985084, 0.836268298769252, 
0.139059781879345, 0.436428268848231, 0.876161680157327, 0.727800373456085, 
0.672905978937657, 0.297360104345131, 0.755453960657994, 0.915263858011323, 
0.749680775533601, 0.698928499115378, 0.681064869099614, 0.140842836586489, 
0.31887911305338, 0.814552412047751, 0.564402284499909, 0.966560569147905, 
0.285680399164402, 0.163096870838754, 0.678999679097116, 0.769586858420342, 
0.421842721106866, 0.847384773890568, 0.375869806916441, 0.91023158156525, 
0.811974234981226, 0.384881076151502, 0.962978502564759, 0.127329629901139, 
0.324180836344761, 0.402358994533595, 0.492524188317, 0.21729219457233, 
0.475761754533503, 0.835414993630778, 0.782356308011642, 0.0824752926936939, 
0.673657511244211, 0.135573315032134, 0.0860250346222518, 0.600455751655231, 
0.188106032117963, 0.936459109104661, 0.678913899205779, 0.358249972965392, 
0.815505461224348, 0.205246062883206, 0.237838546606408, 0.0224452594404064, 
0.73735218489084, 0.495482997399014, 0.422974687329841, 0.976148165349272, 
0.48927664282596, 0.83752889044642, 0.12089508245085, 0.0336652594182381, 
0.486594342721416, 0.527827617989699, 0.23026315490232, 0.325838355549156, 
0.430885327014787, 0.875652362178612, 0.99470678294995, 0.488533304180391, 
0.39268220479532, 0.567389445521645, 0.0582991694487671, 0.373969203452148, 
0.256738407473857, 0.0613575869423953, 0.195825105389589, 0.379947783954051, 
0.959892833776225, 0.528336040267358, 0.0600240356340516, 0.228431360336732, 
0.253512180763246, 0.0333516200630656, 0.939309894377885, 0.819200685249205, 
0.988918333416045, 0.546402817563497, 0.874409700763417, 0.548341739179546, 
0.277241897340785, 0.222867331767495, 0.290128973195648, 0.520798624712869, 
0.0621328787275924, 0.32908493235231, 0.115208010999906, 0.458945089590861, 
0.119203040449451, 0.315996794746558, 0.511886565174822, 0.00626743852957725, 
0.498865667721977, 0.800307896343918, 0.659540368063546, 0.151292790855273, 
0.151883673629264, 0.845194455163074, 0.162113486332309, 0.549145411936252, 
0.949456511975042, 0.128036351248038, 0.679160564563507, 0.774802476115783, 
0.815446482563344, 0.977346838207462, 0.510015943336537, 0.656229662449837, 
0.489897370397628, 0.342436646407341, 0.567056871513228, 0.57418355863059, 
0.497394400045, 0.602944303231875, 0.745946119369578, 0.996610234805717, 
0.182448735452289, 0.99177322970609, 0.336591490602587, 0.542747150463663, 
0.537484387908077, 0.844795914837724, 0.500476658476365, 0.734770917905336, 
0.891150526827217, 0.717381562905834, 0.232958671722472, 0.839858441867139, 
0.656627812896454, 0.646433433703306, 0.0157578607555745, 0.0686766011263438, 
0.316606531399996, 0.271791938480508, 0.220329995816167, 0.63924368096343, 
0.461939627762141, 0.84034841226395, 0.348696682189369, 0.111253048144741, 
0.193400417926945, 0.0668506947097248, 0.162320026513598, 0.322514109546177, 
0.706833989924263, 0.61873118979489, 0.914856208361577, 0.0536871674880708, 
0.239866972373993, 0.51076542955688, 0.878681832409784, 0.191116036490917, 
0.125668598930375, 0.368404543232496, 0.619227561668522, 0.587346957963729, 
0.578149393937774, 0.0283215867724181, 0.485147875945461, 0.467987291050567, 
0.477817246915908, 0.888285341235021, 0.435389033167854, 0.765939711692237, 
0.392663609543762, 0.271149454946659, 0.33579793730755, 0.322835333985247, 
0.848667763413378, 0.068723902558726, 0.192399531298729, 0.0829687805548941, 
0.778562782327858, 0.831997387497907, 0.361953888155996, 0.975001960528926, 
0.465778438590304, 0.855014333773165, 0.272857971061351, 0.364954732466444, 
0.954076453805023, 0.0159770080681279, 0.134622558212419, 0.703145006877828, 
0.458300588109903, 0.768012991470428, 0.834546801567235, 0.818654493245023, 
0.861597897560685, 0.36435677588295, 0.930395006858621, 0.38145707944613, 
0.485264410805612, 0.0230920173888891, 0.708718990927234, 0.114262143500644, 
0.413795431864247, 0.402314895163033, 0.92621342299573, 0.127921206530018, 
0.586306514397575, 0.162114942300604, 0.422833518191204, 0.220588283810223, 
0.66482295161113, 0.67134988782471, 0.234791847136446, 0.506972695899401, 
0.736382914638715, 0.995063043846606, 0.263317401739805, 0.867185107153564, 
0.404505316800033, 0.749360215900758, 0.191354762539416, 0.352748547554609, 
0.257594819936314, 0.574367304163757, 0.126655506363604, 0.353438222332363, 
0.201896397625934, 0.0935953827103887, 0.233644249360474, 0.770619154287478, 
0.552022961766959, 0.00761874253550251, 0.762578569454594, 0.680578596149715, 
0.102183027220563, 0.0381752918009527, 0.641793338163313, 0.627353736374074, 
0.408642190424091, 0.695021571895382, 0.835915446282801, 0.20519885605392, 
0.678891063194775, 0.0927559529329089, 0.364139862856638, 0.34431861183733, 
0.962549888474377, 0.331546198491561, 0.572798888430623, 0.536336761058221, 
0.991751560559476, 0.289993307846055, 0.215341713538198, 0.184418730393535, 
0.00751207276226786, 0.366067328667131, 0.707720542015588, 0.580692479352256, 
0.707488949942435, 0.814757939275814, 0.07302723518821, 0.728880185484228, 
0.395170489475225, 0.922976166566522, 0.363530279469745, 0.373163185432403, 
0.981289067516373, 0.0100024746924422, 0.833199514988427, 0.744005774165126, 
0.520660675773619, 0.949340921842831, 0.763222088141198, 0.53912953960875, 
0.301948961472639, 0.389623143438818, 0.0617781755467086, 0.158229480193394, 
0.179215434400961, 0.474794830950278, 0.191190083461246, 0.813896383322273, 
0.327951077945131, 0.0807385462295783, 0.683851451322015, 0.993642909445778, 
0.741456657461139, 0.932099845856941, 0.100774330551907, 0.850886804588012, 
0.962426063711524, 0.665472533320074, 0.346095855051858, 0.965081040820296, 
0.570164571501862, 0.121056151266223, 0.595822508065309, 0.647818644048096, 
0.306560566142385, 0.239283324542892, 0.831445968259746, 0.0672799050476486, 
0.574900180408842, 0.578531345830948, 0.473362513425723, 0.799785735647465, 
0.832529247528706, 0.573757929474924, 0.87624233727689, 0.512963794370791, 
0.845119708219485, 0.257282658286981, 0.304279522410097, 0.0405635639261398, 
0.597428657910997, 0.153691722060415, 0.498401287538154, 0.661106828791764, 
0.599823434938651, 0.261498474447285, 0.838351500136323, 0.852013572528279, 
0.946778618180373, 0.5020976805196, 0.407650800096471, 0.127873365776576, 
0.194076245730686, 0.63416378384523, 0.823276047169583, 0.646589347011044, 
0.158595797824853, 0.744170190217677, 0.438502259001953, 0.110137125872456, 
0.652024166723739, 0.473106309844618, 0.654145761485286, 0.511191395333077, 
0.103163141658312, 0.594499860887544, 0.990228530661351, 0.633867292373858, 
0.328753006499093, 0.571365745343183, 0.399520668724001, 0.0670885764684551, 
0.494707827197639, 0.147038842994612, 0.0179146127878134, 0.511855752201343, 
0.440593058275629, 0.768598451027766, 0.561623303906775, 0.0977822203939789, 
0.216171178982917, 0.591830926840041, 0.942321703298239, 0.885846853303271, 
0.743472705676186, 0.182789357072978, 0.343851721482336, 0.397515211079916, 
0.388270676901323, 0.957791422470476, 0.876215735074214, 0.0343302054102939, 
0.0458211608444111, 0.593313166842989, 0.848040039577316, 0.936220301916319, 
0.637635961054632, 0.46757780142801, 0.866480181433812, 0.104431001652507, 
0.422361287986911, 0.467083877625872, 0.640347126503394, 0.735602222289796, 
0.159979169677482, 0.926920699053127, 0.0352711162587334, 0.886638234879574, 
0.937915976325935, 0.893256896888054, 0.249754948328842, 0.52085181086901, 
0.185609076479498, 0.955978849846428, 0.265516492210683, 0.798863737106383, 
0.983306701743828, 0.685509731363555, 0.348406346993263, 0.218346855212064, 
0.310689167203427, 0.578539171824965, 0.448789971075139, 0.528580075958527, 
0.631420088640296, 0.0879112519173654, 0.170760168549259, 0.723148401666654, 
0.597943425124816, 0.0494546896122201, 0.524030989146734, 0.0998383157779563, 
0.42458678921923, 0.566952160559276, 0.564813485976376, 0.812599016750946, 
0.108189319056236, 0.0507958182081006, 0.359914676584221, 0.183027238647429, 
0.211240287209685, 0.0199855271637861, 0.150096329742981, 0.657032147327084, 
0.967033818074402, 0.136982643495428, 0.855914208924006, 0.475930464647364, 
0.69866856370827, 0.717902404448902, 0.0553728801592203, 0.847449301654728, 
0.718748895284387, 0.534732248710106, 0.258907803284841, 0.668022503440516, 
0.99222679849908, 0.896741163112969, 0.485625306735209, 0.0409468181739189, 
0.726925376844103, 0.381995649170216, 0.998196866165475, 0.217525334508777, 
0.0514693578809975, 0.410829011055459, 0.609846630877951, 0.951368956361405, 
0.372310979852073, 0.425136372721863, 0.0442383339254772, 0.899386417951806, 
0.935145391784021, 0.769466028709843, 0.971492253290383, 0.766963456919334, 
0.934552327731136, 0.416482459026786, 0.598548713942526, 0.81963280685644, 
0.688498392885815, 0.508307794518759, 0.458567148207537, 0.756575267348749, 
0.417464465119177, 0.166505056428478, 0.523607357588423, 0.150001995540516, 
0.390228711636002, 0.94640560379027, 0.53535666614179, 0.275333706412488, 
0.957963590911106, 0.330886950267614, 0.767942908990291, 0.667559893656278, 
0.503832166782197, 0.93618836328598, 0.890597885999586, 0.00804629755049071, 
0.704608970031961, 0.744102839591455, 0.586732849881375, 0.60814006531042, 
0.78091416631667, 0.333038556839966, 0.776788878444811, 0.903090728138318, 
0.799345371243743, 0.923336154336465, 0.626932651609013, 0.328273452163958, 
0.504500836669912, 0.937502376457183, 0.566390795080742, 0.810889574122998, 
0.53671446430695, 0.55990206684411, 0.462738307229888, 0.843552078041795, 
0.037549408117491, 0.312187484226059, 0.106927402365751, 0.951288657889183, 
0.0823860655150837, 0.133572915716271, 0.418779046703482, 0.792483352217622, 
0.461637880834333, 0.463147870126834, 0.273300424205454, 0.896654194418071, 
0.446456699286285, 0.38892423062237, 0.670872016973032, 0.83927000602317, 
0.806641895568127, 0.0989132802625539, 0.530749763774704, 0.867563356514939, 
0.591343732636015, 0.655894741864744, 0.649267412565414, 0.546918357479427, 
0.180834169396497, 0.978260275049439, 0.499596913485618, 0.214749644434628, 
0.628423993565903, 0.645215513834076, 0.475430221704582, 0.591550832502748, 
0.874744719489567, 0.946743163914992, 0.14007692444784, 0.391343447035281, 
0.245795052283247, 0.614030711296303, 0.147714277798144, 0.760669858233863, 
0.654938265503312, 0.539242267263442, 0.305254977840482, 0.422975191342889, 
0.874102946031246, 0.772139229503756, 0.820136013589263, 0.0519478623644745, 
0.250254675337569, 0.10786783432124, 0.437506115551659, 0.455307637806409, 
0.557784089131155, 0.725391401629418, 0.812854557720646, 0.872161426607888, 
0.264237204839552, 0.783019736130657, 0.703590057806299, 0.883748573777899, 
0.791190538056264, 0.420103391795999, 0.512913118564295, 0.785993431352659, 
0.0736288710609111, 0.471572326886278, 0.444330088746704, 0.868877976851728, 
0.421012989585527, 0.463426879319728, 0.226727134548801, 0.483363239906364, 
0.190689024913399, 0.932896709036063, 0.611877022907302, 0.997179287504618, 
0.647803243234329, 0.231954044957592, 0.379832988992753, 0.873869648895302, 
0.287458621616226, 0.121844655230459, 0.479285990454936, 0.0965269464915844, 
0.751468044042432, 0.957177244464619, 0.302796427303986, 0.591396232199062, 
0.530626372729293, 0.90903810035602, 0.176612565246143, 0.470094596793536, 
0.263658973427753, 0.171710973721412, 0.863696235772208, 0.666439673091327, 
0.877063428846509, 0.210321844152222, 0.992727076437755, 0.184039093459147, 
0.0930396291684462, 0.0830140521295296, 0.331621794267832, 0.42777806091676, 
0.992538122710196, 0.488358282934609, 0.328457576513225, 0.153525420905265, 
0.112148581267026, 0.712455631574307, 0.288443921037935, 0.941451213746591, 
0.067637920316941, 0.290926340822111, 0.355915521280422, 0.361251543215309, 
0.909784020308096, 0.904393720641134, 0.586830348918439, 0.857774251294661, 
0.58014611057709, 0.172836244100916, 0.0757099942476535, 0.554787255686549, 
0.887636942595278, 0.838465335769747, 0.722950259702342, 0.731530368926633, 
0.0848189170625247, 0.123768357213331, 0.57638310407079, 0.604935513364659, 
0.876509343888367, 0.395463429544078, 0.00871187887833753, 0.729843445808869, 
0.913817064943266, 0.427567491890604, 0.555674122473381, 0.0803825967664748, 
0.266773041110792, 0.161886527672524, 0.623802966902259, 0.967172810773647, 
0.918266200039061, 0.365039155883772, 0.455134331750092, 0.17398092517174, 
0.216875507360343, 0.611318452326791, 0.577111029931812, 0.826326762101456, 
0.141694308762219, 0.0746106242325718, 0.998406052913916, 0.445373514729485, 
0.833687515466623, 0.0818697158802192, 0.0235172287595461, 0.211043293807194, 
0.477283685924751, 0.709648742315184, 0.170240102452721, 0.0134593266669973, 
0.749464682154089, 0.71833156661384, 0.08471152160141, 0.906777725987442, 
0.242983628707945, 0.43577093593855, 0.782812465824161, 0.106574484296261, 
0.74211910707719, 0.378310831942327, 0.196328522713685, 0.448964631574391, 
0.342634995843539, 0.862296479901515, 0.799791592848626, 0.0610347360993458, 
0.588285222706082, 0.813166549625958, 0.667392649869056, 0.259232552701265, 
0.20871417137387, 0.856863233656303, 0.21881974646613, 0.00838661366475859, 
0.210491586555817, 0.459306102084144, 0.642923028338682, 0.768980158449878, 
0.463991324822378, 0.187582457717857, 0.226150478169177, 0.912464974778226, 
0.86676952396132, 0.0615933002242949, 0.818839501647901, 0.439869185368464, 
0.126781885099363, 0.969728096934946, 0.270662000113596, 0.46664676179178, 
0.815281620467928, 0.186148460463212, 0.858707933047789, 0.709994239054481, 
0.425058645245414, 0.390242390371138, 0.194262913341872, 0.193165467975052, 
0.383967488595131, 0.115820009180236, 0.653123946952006, 0.810754566043007, 
0.684881156012137, 0.827614188599099, 0.087596999328276, 0.835376844036411, 
0.386368337297456, 0.108535543283917, 0.0933964870000984, 0.208738367929205, 
0.522663810052127, 0.29037431246988, 0.789602860684443, 0.86380529283837, 
0.174327097319454, 0.268804705837418, 0.338290960535358, 0.809439930309295, 
0.901517382098908, 0.988826464408669, 0.936960670917848, 0.463704956151136, 
0.174035853453085, 0.976889223350002, 0.0742864418518531, 0.0471932769298302, 
0.720205353797034, 0.0340184097737368, 0.355233157454544, 0.842332151099015, 
0.509284300787177, 0.0722908197474972, 0.807353649316392, 0.559555556005836, 
0.26817625533348, 0.655214669079761, 0.0955693038586787, 0.259231826332454, 
0.326148755086481, 0.874525695231757, 0.0292051461110117, 0.0648858546354591, 
0.521868009733665, 0.282858882635535, 0.919274078909505, 0.950126941952459, 
0.961514571069072, 0.355046682870965, 0.960919069325817, 0.988694066595547, 
0.616470037149375, 0.132698497002604, 0.806203030647587, 0.934501704202709, 
0.748990707005355, 0.562387441328995, 0.576037311339408, 0.0253023588215532, 
0.258483790129574, 0.0377263844950707, 0.328565326936746, 0.513795922070925, 
0.25569578687378, 0.854377503273344, 0.517557424428899, 0.425022043591909, 
0.92414667048728, 0.61267083690709, 0.320128797158117, 0.0497058535374677, 
0.288789890985052, 0.854562910625096, 0.432418773278565, 0.0563806903067652, 
0.580828066339212, 0.438821116188256, 0.351117823118429, 0.740791585534152, 
0.936961616410724, 0.38526407057734, 0.902839709406609, 0.727520097802416, 
0.223346494083136, 0.795591324863716, 0.792349599706933, 0.848996166766187, 
0.0668169387295173, 0.702660918933782, 0.622191707740462, 0.414788631922888, 
0.254374468350882, 0.895727918225243, 0.797456671261133, 0.300707295273599, 
0.260974490036785, 0.158530184831697, 0.329795258702869, 0.200305070995622, 
0.623589333185384, 0.782676966477629, 0.910501239156033, 0.41096043973708, 
0.455087872045457, 0.336939905558614, 0.725116088548937, 0.7755375709803, 
0.219952810243726, 0.895803057140019, 0.736876968475385, 0.208524988642561, 
0.203737122999009, 0.982691170367749, 0.83449908363247, 0.00484663240770813, 
0.661475574627862, 0.704689693118506, 0.376002920530063, 0.20370330681329, 
0.846566611214415, 0.0858108345419686, 0.615970959996433, 0.896246076499934, 
0.481752608002906, 0.667248965657097, 0.42900941594109, 0.246855735712645, 
0.905607160176915, 0.304345337949573, 0.400219650425477, 0.189859669737602, 
0.195238410580684, 0.245221324536143, 0.384554352402482, 0.604283439138313, 
0.341548861566008, 0.468771843229542, 0.610547730668572, 0.469009494819238, 
0.580405092329549, 0.128337631111712, 0.727645279643532, 0.0922491301603008, 
0.363518634581867, 0.374935820463058, 0.567251121341855, 0.816912554724127, 
0.761092330461847, 0.969175022868856, 0.366015539428951, 0.914452449206806, 
0.914559107535378, 0.589669443341116, 0.131665674649164, 0.769421490530853, 
0.629522411553079, 0.393277115759503, 0.605582995159851, 0.425782661202144, 
0.484791108035225, 0.200562160409863, 0.370432473044046, 0.152636418453425, 
0.0831945225940066, 0.61453976180882, 0.738189791919098, 0.864335162095502, 
0.359673748288356, 0.127454832116099, 0.767357297905638, 0.980912507417928, 
0.546365651956242, 0.0653137698644937, 0.321714988967643, 0.101770870562858, 
0.103706738935911, 0.729469452393808, 0.855403754545674, 0.0121276673191686, 
0.00829964643571102, 0.0584003693939428, 0.298905206000803, 0.342002095807633, 
0.601165424977892, 0.767181415667645, 0.0878824990415346, 0.791401173658762, 
0.904368097320225, 0.629746467372962, 0.755910034672251, 0.17651732693514, 
0.322032852285933, 0.574685965814267, 0.152328004661564, 0.323455318669141, 
0.483390038455874, 0.977028090409415, 0.326576018878085, 0.330881823104078, 
0.736294851173983, 0.530967398256693, 0.611326747474883, 0.448246097667782, 
0.410486882065918, 0.636831109827233, 0.113230744880688, 0.0692156053155621, 
0.761643461325193, 0.177839188324019, 0.157436963455035, 0.376416956339179, 
0.345853419439658, 0.354689308497442, 0.697518361016957, 0.712815200215327, 
0.701882273119456, 0.597385367026053, 0.847894785399977, 0.197379474491307, 
0.310893805426356, 0.406999867910145, 0.830116026506272, 0.305719192501626, 
0.951748252614888, 0.250763332257012, 0.977012934203431, 0.268626974395229, 
0.761229297006802, 0.998875331532707, 0.996410361223943, 0.521462666910758, 
0.270661826621762, 0.703678258105308, 0.628977365640988, 0.438539061552906, 
0.673308732005723, 0.673255292991587, 0.00444270507053175, 0.0758383902581702, 
0.337758317112912, 0.413899055337743, 0.964681433735749, 0.537001593767613, 
0.516805678394614, 0.356324543418162, 0.0824234684676958, 0.813042188012974, 
0.41936384198371, 0.499989871999742, 0.885182431826935, 0.874032005625778, 
0.087604398092412, 0.767780710256717, 0.37095945589395, 0.245274390742242, 
0.0920526125251148, 0.422176568203722, 0.120052597352991, 0.203095058098467, 
0.272640819146949, 0.036809258556319, 0.968302470637439, 0.785877243272312, 
0.538031636561146, 0.201141756153632, 0.188675511602756, 0.727021463440299, 
0.795744723108148, 0.0966718235556608, 0.711390441485177, 0.576479021202215, 
0.174227200641543, 0.954330472898385, 0.754378455051598, 0.257367641841118, 
0.022122406505315, 0.747595188950798, 0.612234061387394, 0.948758823874003
)
abc <-
function (x, y) 
{
  x + Y
}
Beta <-
function (params) 
{
    alpha = params[1]
    beta  = params[2]
    
    tmp <- list(
                Model = "Beta"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dbeta(x, alpha, beta)
                },
                Cdf = function(x)
                {
                    pbeta(x, alpha, beta)
                },
                Quantile = function(p)
                {
                    qbeta(p, alpha, beta)
                },
                Roll = function(n)
                {
                    rbeta(n, alpha, beta)
                },
                Mean<-params[1]*params[2]
                ,
                Variance<- params[1]^2
    )
    class(tmp)="RandomVar"
    tmp
    
    
}
Binomial <-
function (params) 
{
    n = params[1]
    p = params[2]
    
    tmp <- list(
                Model = "Binomial"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dbinomial(x, n, p)
                },
                Cdf = function(x)
                {
                    pbinomial(x, n, p)
                },
                Quantile = function(q)
                {
                    qbinomial(q, n, p)
                },
                Roll = function(sampleSize)
                {
                    rbinomial(sampleSize, n, p)
                },
                Mean<-params[1]*params[2]
                ,
                Variance<- params[1]^2
    )
    class(tmp)="RandomVar"
    tmp
    
    
}
bstraub <-
function(ratios   , 
                    weights  , 
                    method  = c("unbiased", "iterative"),
                    tol     = sqrt(.Machine$double.eps), 
                    maxit   = 100, 
                    echo    = FALSE
                    )
{
    ## If weights are not specified, use equal weights as in
    ## Buhlmann's model.
    if (missing(weights))
    {
        if (any(is.na(ratios)))
            stop("missing ratios not allowed when weights are not supplied")
        weights <- array(1, dim(ratios))
    }

    ## Check other bad arguments.
    if (ncol(ratios) < 2)
        stop("there must be at least one node with more than one period of experience")
        
    if (nrow(ratios) < 2)
        stop("there must be more than one node")
        
    if (!identical(which(is.na(ratios)), which(is.na(weights))))
        stop("missing values are not in the same positions in 'weights' and in 'ratios'")
        
    if (all(!weights, na.rm = TRUE))
        stop("no available data to fit model")

    ## Individual weighted averages. It could happen that a contract
    ## has no observations, for example when applying the model on
    ## claim amounts. In such a situation, we will put the total
    ## weight of the contract and the weighted average both equal to
    ## zero. That way, the premium will be equal to the credibility
    ## weighted average, as it should, but the contract will have no
    ## contribution in the calculations.
    weights.s <- rowSums(weights, na.rm = TRUE)
    catp(weights.s)
    
    ratios.w <- ifelse(weights.s > 0, rowSums(weights * ratios, na.rm = TRUE) / weights.s, 0)
    catp(ratios.w)
    
    ## Size of the portfolio.
    ncontracts <- sum(weights.s > 0)
    catp(ncontracts)
    
    ntotal <- sum(!is.na(weights))
    catp(ntotal)

    ## Collective weighted average.
    weights.ss <- sum(weights.s)
    catp(weights.ss)
    
    
    ## Estimation of s^2
    s2 <-  sum(weights * (ratios - ratios.w)^2, na.rm = TRUE) / (ntotal - ncontracts)
    catp(s2)
    
    ## First estimation of a. Always compute the unbiased estimator.
    a <- bvar.unbiased(ratios.w, weights.s, s2, ncontracts)
    catp(a)
    
    ## Iterative estimation of a. Compute only if
    ## 1. asked to in argument;
    ## 2. weights are not all equal (Buhlmann model).
    ## 3. the unbiased estimator is > 0;
    method <- match.arg(method)

    catp(method)
    
    if (method == "iterative" &&
        diff(range(weights, na.rm = TRUE)) > .Machine$double.eps^0.5)
    {
        a <-
            if (a > 0)
                bvar.iterative(ratios.w, weights.s, s2, ncontracts, start = a,
                               tol = tol, maxit = maxit, echo = echo)
            else
                0
    }

    ## Final credibility factors and estimator of the collective mean.
    if (a > 0)
    {
        cred <- 1 / (1 + s2/(weights.s * a))
        ratios.zw <- drop(crossprod(cred, ratios.w)) / sum(cred)
    }
    else
    {
        cred <- numeric(length(weights.s))
        ratios.zw <- drop(crossprod(weights.s, ratios.w)) / sum(weights.s)
    }

    catp(ratios.zw)
    catp(ratios.w)
    
    structure(list(means = list(ratios.zw, ratios.w),
                   weights = list(if (a > 0) sum(cred) else weights.ss, weights.s),
                   unbiased = if (method == "unbiased") c(a, s2),
                   iterative = if (method == "iterative") c(a, s2),
                   cred = cred,
                   nodes = list(nrow(weights))),
              class = "bstraub",
              model = "Buhlmann-Straub")
}
bvar.iterative <-
function(x, w, within, n, start,
                           tol = sqrt(.Machine$double.eps), maxit = 100,
                           echo = FALSE)
{
    if (echo)
    {
        cat("Iteration\tBetween variance estimator\n")
        exp <- expression(cat(" ", count, "\t\t ", a1 <- a, fill = TRUE))
    }
    else
        exp <- expression(a1 <-  a)

    a <- start
    count <- 0

    repeat
    {
        eval(exp)

        if (maxit < (count <- count + 1))
        {
            warning("maximum number of iterations reached before obtaining convergence")
            break
        }

        cred <- 1 / (1 + within/(w * a))
        x.z <- drop(crossprod(cred, x)) / sum(cred)
        a <- drop(crossprod(cred, (x - x.z)^2)) / (n - 1)

        if (abs((a - a1)/a1) < tol)
            break
    }
    a
}
bvar.unbiased <-
function(x, w, within, n)
{
    w.s <- sum(w)
    x.w <- drop(crossprod(w, x)) / w.s
    catp(x.w)
    catp(w.s)
    
    catp(w)
    catp(x)
    catp(x.w)
    
    
    cp = drop(crossprod(w, (x - x.w)^2))
    catp(cp)
    
    mwith=(n - 1) * within
    catp(mwith)
    
    den = (w.s^2 - sum(w^2))
    catp(den)
    
    myout = w.s *( cp - mwith)/den
    catp(myout)
    
    w.s * (drop(crossprod(w, (x - x.w)^2)) - (n - 1) * within) / (w.s^2 - sum(w^2))
}
catp <-
function (x) 
{
  if(DEBUG)
  {
    cat("\n====", as.list(match.call())$x, " ==== \n")
    print(x)
    cat(" ---------------------------------\n")
  }
  
}
circle <-
function (x,y, radius=1, n=100) 
{
  theta = 2*pi*(0:n)/n
  X = x + radius*cos(theta)
  Y = y + radius*sin(theta)
  lines(X,Y)
}
cm <-
function(formula, data, ratios, weights, subset,
               regformula = NULL, regdata, adj.intercept = FALSE,
               method = c("Buhlmann-Gisler", "Ohlsson", "iterative"),
               tol = sqrt(.Machine$double.eps), maxit = 100,
               echo = FALSE)
{
    Call <- match.call()

    ## === MODEL ANALYSIS ===
    ##
    ## Decompose the formula giving the portfolio structure. Attribute
    ## "order" gives the interaction level of each term in the
    ## formula. In hierarchical structures, each term should represent
    ## a different level, hence there should not be any duplicates in
    ## this attribute. The column names in 'data' containing the
    ## portfolio structure can be obtained from the rownames of the
    ## matrix in attribute "factors".
    ##
    ## Note that the very last level, the data, is not taken into
    ## account here.
    tf <- terms(formula)
    level.numbers <- attr(tf, "order")           # level IDs
    level.names <- rownames(attr(tf, "factors")) # level names
    nlevels <- length(level.names)               # number of levels

    ## Sanity checks
    ##
    ## 1. only hierarchical interactions are allowed in 'formula';
    ## 2. hierarchical regression models are not supported.
    ## 3. if 'ratios' is missing, all columns of 'data' are taken to
    ##    be ratios, so 'weights' should also be missing;
    ##
    if (any(duplicated(level.numbers)))
        stop("unsupported interactions in 'formula'")
    if (nlevels > 1 && !is.null(regformula))
        stop("hierarchical regression models not supported")
    if (missing(ratios) & !missing(weights))
        stop("ratios have to be supplied if weights are")

    ## === DATA EXTRACTION ===
    ##
    ## 'data' is split into three matrices: one for the portfolio
    ## structure, one for the ratios and one for the weights. They are
    ## obtained via calls to subset() built from this function's
    ## call. That way, arguments 'ratios', 'weights' and 'subset' are
    ## not evaluated before being passed to subset(). Argument
    ## matching is as follows:
    ##
    ##   Argument of cm()     Argument of subset()
    ##   ================     ====================
    ##     data                 x
    ##     ratios               select
    ##     weights              select
    ##     subset               subset
    ##
    ## Positions of the arguments that will be needed.
    m <- match(c("data", "ratios", "weights", "subset"), names(Call), 0)

    ## Extraction of the portfolio structure. Arguments 'data' and
    ## 'subset' are passed to subset().
    cl <- Call[c(1, m[c(1, 4)])]        # use data and subset only
    cl[[1]] <- as.name("subset")        # change function name
    names(cl)[2] <- "x"                 # argument matching
    cl$select <- level.names            # add argument 'select'
    levs <- eval(cl, parent.frame())    # extraction

    ## Object 'levs' is a data frame or matrix with as many colums as
    ## there are levels in the model (still notwithstanding the data
    ## level). Rows contain nodes identifiers which can be
    ## anything. For calculations, these identifiers are converted
    ## into simple subscripts (i, j, k, ...) as used in mathematical
    ## notation.
    ##
    ## Note that 'apply' will coerce to a matrix.
    ilevs <- apply(levs, 2, function(x) as.integer(factor(x)))

    ## Extraction of the ratios. If argument 'ratios' is missing, then
    ## use all columns of 'data' except those of the portfolio
    ## structure.
    cl$select <-
        if (missing(ratios))
            setdiff(colnames(data), level.names)
        else
            Call[[m[2]]]
    ratios <- as.matrix(eval(cl, parent.frame())) # ratios as matrix

    ## Creation of a weight matrix. Extract from data if argument
    ## 'weights' is specified, otherwise create a matrix of ones. For
    ## extraction, the only change from ratio extraction is the
    ## content of element "select" of the call.
    weights <-
        if (missing(weights))
        {
            if (any(is.na(ratios)))
                stop("missing ratios not allowed when weights are not supplied")
            array(1, dim(ratios))       # matrix of ones
        }
        else
        {
            cl$select <- Call[[m[3]]]
            as.matrix(eval(cl, parent.frame())) # weights as matrix
        }

    ## == DISPATCH TO APPROPRIATE CALCULATION FUNCTION ==
    ##
    ## Buhlmann-Straub models are handled by bstraub(), regression
    ## models by hache() and hierarchical models by hierarc().
    if (nlevels < 2)                    # one-dimensional model
    {
        ## One-dimensional models accept only "unbiased" and
        ## "iterative" for argument 'method'.
        method <- match.arg(method)
        if (method == "Buhlmann-Gisler" || method == "Ohlsson")
            method <- "unbiased"

        if (is.null(regformula))        # Buhlmann-Straub
        {
            catp(ratios)
            catp(weights)
            catp(method)
            catp(tol)
            catp(maxit)
            catp(echo)
            res <- bstraub(ratios, weights, method = method,
                           tol = tol, maxit = maxit, echo = echo)
        }
        else                            # Hachemeister
        {
            ## If regression model is actually empty or has only an
            ## intercept, call bstraub().
            trf <- terms(regformula)
            res <-
                if (length(attr(trf, "factors")) == 0)
                {
                    warning("empty regression model; fitting with Buhlmann-Straub's model")
                    bstraub(ratios, weights, method = method,
                            tol = tol, maxit = maxit, echo = echo)
                }
                else
                    hache(ratios, weights, regformula, regdata,
                          adj.intercept = adj.intercept,
                          method = method, tol = tol,
                          maxit = maxit, echo = echo)
        }

        ## Add missing quantities to results.
        res$classification <- levs
        res$ordering <- list(seq_along(levs))
    }
    else                                # hierarchical model
    {
        ## Computations with auxiliary function.
        res <- hierarc(ratios, weights, classification = ilevs,
                       method = method, tol = tol, maxit = maxit,
                       echo = echo)

        ## Put back original level names into the object
        res$classification <- levs
    }

    ## Transfer level names to lists
    names(res$means) <- names(res$weights) <- c("portfolio", level.names)
    names(res$unbiased) <- if (!is.null(res$unbiased)) names(res$means)
    names(res$iterative) <- if (!is.null(res$iterative)) names(res$means)
    names(res$nodes) <- names(res$ordering) <- level.names
    if (is.list(res$cred))
        names(res$cred) <- level.names

    ## Results
    class(res) <- c("cm", class(res))
    attr(res, "call") <- Call
    res
}
DEBUG <-
TRUE
delta <-
c(0, -0.133)
e <-
structure(list(Model = "Exponential", Parameters = 500, Pdf = function(x)
                {
                    dexp(x,rate)
                }, Cdf = function(x)
                {
                    pexp(x,rate)
                }, Quantile = function(p)
                {
                    qexp(p,rate)
                }, Roll = function(n)
                {
                    rexp(n,rate)
                }, 500, 250000), .Names = c("Model", "Parameters", 
"Pdf", "Cdf", "Quantile", "Roll", "", ""), class = "RandomVar")
Exponential <-
function (params) 
{
    rate = 1/params[1]
    
    tmp <- list(
                Model = "Exponential"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dexp(x,rate)
                },
                Cdf = function(x)
                {
                    pexp(x,rate)
                },
                Quantile = function(p)
                {
                    qexp(p,rate)
                },
                Roll = function(n)
                {
                    rexp(n,rate)
                },
                Mean<-params[1]
                ,
                Variance<- params[1]^2
    )
    
    #tmp = list(Model="Exponential", Parameters=params, Pdf=myPdf,Cdf=myCdf,Quantile=myQuantile,Roll=myRoll, Mean=myMean, Variance=myVariance)
    class(tmp)="RandomVar"
    tmp
    
    
}
functions <-
function (name, pos = -1, envir = as.environment(pos), all.names = FALSE, 
    pattern) 
{
    if (!missing(name)) {
        nameValue <- try(name, silent = TRUE)
        if (identical(class(nameValue), "try-error")) {
            name <- substitute(name)
            if (!is.character(name)) 
                name <- deparse(name)
            warning(sQuote(name), " converted to character string")
            pos <- name
        }
        else pos <- nameValue
    }
    all.names <- .Internal(ls(envir, all.names))
    if (!missing(pattern)) {
        if ((ll <- length(grep("[", pattern, fixed = TRUE))) && 
            ll != length(grep("]", pattern, fixed = TRUE))) {
            if (pattern == "[") {
                pattern <- "\\["
                warning("replaced regular expression pattern '[' by  '\\\\['")
            }
            else if (length(grep("[^\\\\]\\[<-", pattern))) {
                pattern <- sub("\\[<-", "\\\\\\[<-", pattern)
                warning("replaced '[<-' by '\\\\[<-' in regular expression pattern")
            }
        }
        grep(pattern, all.names, value = TRUE)
    }
    else all.names
}
g <-
structure(list(Model = "Gamma", Parameters = c(3, 445), Pdf = function(x)
                {
                    dgamma(x, params[1], rate)
                }, Cdf = function(x)
                {
                    pgamma(x, params[1], rate)
                }, Quantile = function(p)
                {
                    qgamma(p, params[1], rate)
                }, Roll = function(n)
                {
                    rgamma(n, params[1], rate)
                }, 1335, 9), .Names = c("Model", "Parameters", 
"Pdf", "Cdf", "Quantile", "Roll", "", ""), class = "RandomVar")
Gamma <-
function (params) 
{
    rate = 1/params[2]
    
    tmp <- list(
                Model = "Gamma"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dgamma(x, params[1], rate)
                },
                Cdf = function(x)
                {
                    pgamma(x, params[1], rate)
                },
                Quantile = function(p)
                {
                    qgamma(p, params[1], rate)
                },
                Roll = function(n)
                {
                    rgamma(n, params[1], rate)
                },
                Mean<-params[1]*params[2]
                ,
                Variance<- params[1]^2
    )
    class(tmp)="RandomVar"
    tmp
    
    
}
Gamma2 <-
function (params) 
{
    rate = 1/params[2]
    
    tmp <- list(
                Model = "Gamma"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dgamma(x, params[1], rate)
                },
                Cdf = function(x)
                {
                    pgamma(x, params[1], rate)
                },
                Quantile = function(p)
                {
                    qgamma(p, params[1], rate)
                },
                Roll = function(n)
                {
                    rgamma(n, params[1], rate)
                },
                Mean<-params[1]*params[2]
                ,
                Variance<- params[1]^2
    )
    class(tmp)="RandomVar"
    tmp
    
    
}
gearCutters <-
structure(c(0.5, 1, 1.25, 1.5, 1.75, 2, 2.5, 3, 4, 8.62, 9.36, 
9.02, 9.39, 10.99, 10.79, 10.62, 13.08, 17.58), .Dim = c(9L, 
2L))
get_script_path <-
function() {
  cmdArgs = commandArgs(trailingOnly = FALSE)
  needle = "--file="
  match = grep(needle, cmdArgs)
  if (length(match) > 0) {
    # Rscript
    return(normalizePath(sub(needle, "", cmdArgs[match])))
  } else {
    ls_vars = ls(sys.frames()[[1]])
    if ("fileName" %in% ls_vars) {
      # Source'd via RStudio
      return(normalizePath(sys.frames()[[1]]$fileName)) 
    } else {
      # Source'd via R console
      return(normalizePath(sys.frames()[[1]]$ofile))
    }
  }
}
hachemeister <-
structure(c(1, 2, 3, 4, 5, 1738, 1364, 1759, 1223, 1456, 1642, 
1408, 1685, 1146, 1499, 1794, 1597, 1479, 1010, 1609, 2051, 1444, 
1763, 1257, 1741, 2079, 1342, 1674, 1426, 1482, 2234, 1675, 2103, 
1532, 1572, 2032, 1470, 1502, 1953, 1606, 2035, 1448, 1622, 1123, 
1735, 2115, 1464, 1828, 1343, 1607, 2262, 1831, 2155, 1243, 1573, 
2267, 1612, 2233, 1762, 1613, 2517, 1471, 2059, 1306, 1690, 7861, 
1622, 1147, 407, 2902, 9251, 1742, 1357, 396, 3172, 8706, 1523, 
1329, 348, 3046, 8575, 1515, 1204, 341, 3068, 7917, 1622, 998, 
315, 2693, 8263, 1602, 1077, 328, 2910, 9456, 1964, 1277, 352, 
3275, 8003, 1515, 1218, 331, 2697, 7365, 1527, 896, 287, 2663, 
7832, 1748, 1003, 384, 3017, 7849, 1654, 1108, 321, 3242, 9077, 
1861, 1121, 342, 3425), .Dim = c(5L, 25L), .Dimnames = list(NULL, 
    c("state", "ratio.1", "ratio.2", "ratio.3", "ratio.4", "ratio.5", 
    "ratio.6", "ratio.7", "ratio.8", "ratio.9", "ratio.10", "ratio.11", 
    "ratio.12", "weight.1", "weight.2", "weight.3", "weight.4", 
    "weight.5", "weight.6", "weight.7", "weight.8", "weight.9", 
    "weight.10", "weight.11", "weight.12")))
hachemeister2 <-
structure(c(1, 2, 1, 2, 2, 1, 2, 3, 4, 5, 1738, 1364, 1759, 1223, 
1456, 1642, 1408, 1685, 1146, 1499, 1794, 1597, 1479, 1010, 1609, 
2051, 1444, 1763, 1257, 1741, 2079, 1342, 1674, 1426, 1482, 2234, 
1675, 2103, 1532, 1572, 2032, 1470, 1502, 1953, 1606, 2035, 1448, 
1622, 1123, 1735, 2115, 1464, 1828, 1343, 1607, 2262, 1831, 2155, 
1243, 1573, 2267, 1612, 2233, 1762, 1613, 2517, 1471, 2059, 1306, 
1690, 7861, 1622, 1147, 407, 2902, 9251, 1742, 1357, 396, 3172, 
8706, 1523, 1329, 348, 3046, 8575, 1515, 1204, 341, 3068, 7917, 
1622, 998, 315, 2693, 8263, 1602, 1077, 328, 2910, 9456, 1964, 
1277, 352, 3275, 8003, 1515, 1218, 331, 2697, 7365, 1527, 896, 
287, 2663, 7832, 1748, 1003, 384, 3017, 7849, 1654, 1108, 321, 
3242, 9077, 1861, 1121, 342, 3425), .Dim = c(5L, 26L), .Dimnames = list(
    NULL, c("cohort", "state", "ratio.1", "ratio.2", "ratio.3", 
    "ratio.4", "ratio.5", "ratio.6", "ratio.7", "ratio.8", "ratio.9", 
    "ratio.10", "ratio.11", "ratio.12", "weight.1", "weight.2", 
    "weight.3", "weight.4", "weight.5", "weight.6", "weight.7", 
    "weight.8", "weight.9", "weight.10", "weight.11", "weight.12"
    )))
hierarc <-
function(
                    ratios, 
                    weights, 
                    classification,
                    method = c("Buhlmann-Gisler", "Ohlsson", "iterative"),
                    tol    = sqrt(.Machine$double.eps), 
                    maxit  = 100,
                    echo   = FALSE
                    )
{
    catp(ratios)
    catp(weights)
    catp(classification)
    catp(method)
    
    ## === HANDS ON THE DATA ===
    ##
    ## Arguments 'ratios' and 'weights' must be matrices of real
    ## numbers, whereas 'classification' must be a matrix of integers
    ## giving the affiliation of each entity in the portfolio.
    nlevels <- ncol(classification)              # number of levels
    nlevels1p <- nlevels + 1L                    # frequently used
    catp(nlevels)
    catp(nlevels1p)

    ## To symmetrize further calculations, bind a column of ones
    ## representing the affiliation to the global portfolio.
    classification <- cbind(pf = 1L, classification)
    catp(classification)

    ## If weights are not specified, use equal weights.
    if (missing(weights))
    {
        if (any(is.na(ratios)))
            stop("missing ratios not allowed when weights are not supplied")
        array(1, dim(ratios))       # matrix of ones
    }

    ## Sanity check if weights and ratios correspond.
    if (!identical(which(is.na(ratios)), which(is.na(weights))))
        stop("missing values are not in the same positions in 'weights' and in 'ratios'")

    ## === NUMBER OF NODES AND SPLITTING FACTORS ===
    ##
    ## Future computation of per level summaries will require a set of
    ## factors based on the number of nodes in each level. An example
    ## will best explain what is achieved here: suppose there are two
    ## sectors; sector 1 has 3 units; sector 2 has 2 units. To make
    ## per sector summaries, the following factors can be used to
    ## split the unit data: 1 1 1 2 2.
    ##
    ## Generating such factors first requires to know the number of
    ## nodes at each level in a format identical to the 'nodes'
    ## argument of simul(). [In the previous example, the number of
    ## nodes would be 'list(2, c(3, 2))'.] Then, the factors are
    ## obtained by repeating a sequence the same length as the number
    ## of nodes at one level [2] according to the number of nodes at
    ## the level below [c(3, 2)].
    ##
    ## 0. Initialization
    fnodes <- nnodes <- vector("list", nlevels)
    catp(fnodes)
    catp(nnodes)

    ## 1. Calculation of the number of nodes: the main idea is to
    ## create a unique factor for each node using interaction()
    ## recursively on the columns of 'classification'. We can do
    ## something simpler for the lowest level (the entities), since we
    ## know the combinations of indexes to all be different at this
    ## level.
    fx <- vector("list", nlevels1p)
    fx[[nlevels1p]] <- factor(classification[, nlevels1p]) # entity level
    catp(fx)

    for (i in nlevels:1L)
    {
        ## Function 'interaction' expects its arguments separately or
        ## as a list, hence the lapply() below.
        fx[[i]] <- as.integer(interaction(lapply(seq.int(i),
                                                 function(j) classification[, j]),
                                          drop = TRUE))
        ## 'as.vector' below is used to get rid of names
        nnodes[[i]] <- as.vector(sapply(split(fx[[i + 1]], fx[[i]]),
                                        function(x) length(unique(x))))
    }
    catp(fx)

    ## 2. Generation of the factors. Following the rule described
    ## above, this could simply be
    ##
    ##   fnodes <- lapply(nnodes, function(x) rep(seq_along(x), x))
    ##
    ## However, this will not work if rows of data are not sorted per
    ## level. (In the example above, if the data of unit 3 of sector 1
    ## is at the bottom of the matrix of data, then the factors need
    ## to be 1 1 2 2 1.)
    ##
    ## The solution is actually simple: converting the entity level
    ## factors ('fx[[nlevels]]') to integers will assure that any
    ## summary made using these factors will be sorted. This done, it
    ## is possible to use the command above for the upper levels.
    fnodes[[nlevels]] <- as.integer(fx[[nlevels]])
    fnodes[-nlevels] <- lapply(nnodes[-nlevels],
                               function(x) rep(seq_along(x), x))
    catp(fx)
    catp(fnodes)
    
    ## === PER ENTITY SUMMARIES ===
    ##
    ## Individual weighted averages. It could happen that an entity
    ## has no observations, for example when applying the model on
    ## claim amounts. In such a situation, put the total weight of the
    ## entity and the weighted average both equal to zero. That way,
    ## the premium will be equal to the credibility weighted average,
    ## as it should, but the entity will otherwise have no
    ## contribution in the calculations.
    weights.s <- rowSums(weights, na.rm = TRUE)
    ratios.w <- ifelse(weights.s > 0, rowSums(weights * ratios, na.rm = TRUE) / weights.s, 0)
    catp(weights.s)
    catp(ratios.w)

    ## === EFFECTIVE NUMBER OF NODES ===
    ##
    ## Given the possibility to have whole levels with no data, as
    ## explained above, it is necessary to count the *effective*
    ## number of nodes in each level, that is the number of nodes with
    ## data. This comes this late since it relies on 'weights.s'.
    ##
    ## Object 'eff.nnodes' is in every respect equivalent to 'nnodes'
    ## except that each element of the list is a vector of the number of
    ## non "empty" nodes for each classification of the level
    ## above.
    eff.nnodes <- vector("list", nlevels)
    catp(eff.nnodes)
    
    w <- weights.s
    catp(w)
    
    for (i in nlevels:1L)
    {
        eff.nnodes[[i]] <- tapply(w, fnodes[[i]], function(x) sum(x > 0))
        w <- tapply(w, fnodes[[i]], sum) # running totals
        catp(i)
        catp(w)
    }
    catp(eff.nnodes)
    catp(w)
    
    ## === DENOMINATORS OF VARIANCE ESTIMATORS ===
    ##
    ## The denominators for all the variance estimators never
    ## change. The denominator at one level is equal to the total
    ## number of nodes at that level minus the total number of nodes
    ## at the level above. At the lowest level (the denominator of
    ## s^2), this is
    ##
    ##   number of (non NA) ratios - (effective) number of entities.
    ##
    ## The number of (non missing) ratios is not included in
    ## 'eff.nnodes'.  For the portfolio level, the denominator is
    ##
    ##   (effective) number of "sectors" - 1
    ##
    ## The 1 neither is included in 'eff.nnodes'.
    denoms <- diff(c(1L, sapply(eff.nnodes, sum), sum(!is.na(ratios))))
    catp(denoms)
    ## Final sanity checks
    if (any(!denoms))
        stop("there must be at least two nodes at every level")
    if (ncol(ratios) < 2L)
        stop("there must be at least one node with more than one period of experience")

    ## === ESTIMATION OF s^2 ===
    s2 <-  sum(weights * (ratios - ratios.w)^2, na.rm = TRUE) /
        denoms[nlevels1p]
    catp(s2)
    
    ## === ESTIMATION OF THE OTHER VARIANCE COMPONENTS ===
    ##
    ## Create vectors to hold values to be computed at each level
    ## (from portfolio to entity), namely: the total node weights, the
    ## node weighted averages, the between variances and the node
    ## credibility factors.
    ##
    ## Only credibility factors are not computed for the portfolio
    ## level, hence this list is one shorter than the others.
    tweights <- vector("list", nlevels1p)       # total level weights
    wmeans <- vector("list", nlevels1p)         # weighted averages
    b <- c(numeric(nlevels), s2)                # variance estimators
    cred <- vector("list", nlevels)             # credibility factors

    catp(b)
    catp(cred)

    
    ## Values already computed at the entity level.
    tweights[[nlevels1p]] <- as.vector(weights.s);
    wmeans[[nlevels1p]] <- as.vector(ratios.w);
    catp(tweights)
    catp(wmeans)

    ## The unbiased variance estimators are evaluated first as they will
    ## be used as starting values for the iterative part below.
    ##
    ## At the entity level: node weight is given by the natural
    ## weight, weighted averages use the natural weights.
    ##
    ## Level above the entity: node weight is the sum of the natural
    ## weights at the level below, weighted averages use the natural
    ## weights.
    ##
    ## All upper levels: node weight is the sum of the credibility
    ## factors at the level below, weighted averages use credibility
    ## factors from previous level.
    ##
    ## Buhlmann-Gisler estimators truncate the per node variance
    ## estimates to 0 before taking the mean, whereas the Ohlsson
    ## estimators do not make any truncation.
    method <- match.arg(method)

    if (method == "Buhlmann-Gisler")
        bexp <- expression(b[i] <- mean(pmax(ifelse(ci != 0, bi/ci, 0), 0), na.rm = TRUE))
    else                                # Ohlsson
        bexp <- expression(b[i] <- sum(bi, na.rm = TRUE) / sum(ci, na.rm = TRUE))

    for (i in nlevels:1L)
    {
        ## Total weight of the level as per the rule above.
        tweights[[i]] <- as.vector(tapply(tweights[[i + 1L]], fnodes[[i]], sum))

        ## Calculation of the weighted averages of the level. Before
        ## the between variance is estimated, these use the total
        ## weights calculated above.
        wmeans[[i]] <-
            ifelse(tweights[[i]] > 0,
                   as.vector(tapply(tweights[[i + 1L]] * wmeans[[i + 1L]],
                                    fnodes[[i]],
                                    sum) / tweights[[i]]),
                   0)

        ## Latest non-zero between variance estimate -- the one used
        ## in the estimator and in the credibility factors.
        between <- b[b != 0][1L]

        ## Calculation of the per node variance estimate.
        bi <- as.vector(
                            tapply(
                                    tweights[[i + 1L]] *
                                    (wmeans[[i + 1L]] - wmeans[[i]][fnodes[[i]]])^2,
                                    fnodes[[i]],
                                    sum
                                  )
                        ) 
                        - (eff.nnodes[[i]] - 1) * between
        ci <- tweights[[i]] -
            as.vector(
                      tapply(
                             tweights[[i + 1L]]^2, 
                             fnodes[[i]], 
                             sum
                             )
                      )/ tweights[[i]]

        ## The final estimate is the average of all the per node estimates.
        eval(bexp)

        ## Calculation of the credibility factors. If these are
        ## non-zero, the total weights for the current level are
        ## replaced by the sum of the credibility factors and the
        ## weighted averages are recomputed with these new weights.
        #if (max(bu[i], 0))           # don't compute negative factors!
        if (b[i])
        {
            cred[[i]] <- 1/(1 + between/(b[i] * tweights[[i + 1L]]))
            tweights[[i]] <- as.vector(tapply(cred[[i]], fnodes[[i]], sum))
            
            wmeans[[i]] <-
                ifelse(
                       tweights[[i]] > 0,
                       as.vector(
                                 tapply(
                                        cred[[i]] * wmeans[[i + 1L]],
                                        fnodes[[i]],
                                        sum
                                        ) 
                                        / 
                                        tweights[[i]]
                                ),
                       0
                       )
        }
        else
            cred[[i]] <- numeric(sum(nnodes[[i]]))
    }
    catp(tweights)
    catp(wmeans)
    catp(b)
    catp(cred)

    ## Iterative estimation of the structure parameters.
    ##
    ## At the entity level: total weight is the sum of the natural
    ## weights, weighted averages use the natural weights and between
    ## variance is s^2.
    ##
    ## All upper levels: total weight is the sum of the credibility
    ## factors of the level below, weighted averages use credibility
    ## factors, between variance estimated recursively and credibility
    ## factor use total weight of the level, between variance of the
    ## level below (hence the within variance) and between variance of
    ## the current level.
    if (method == "iterative")
    {
        b <- pmax(b, 0)            # truncation for starting values
        if (any(head(b, -1L) > 0)) # at least one non-zero starting value
            .External(
                      "actuar_do_hierarc", 
                      cred, 
                      tweights, 
                      wmeans, 
                      fnodes, 
                      denoms,
                      b, 
                      tol, 
                      maxit, 
                      echo
                      )
    }

    ## Results
    structure(
              list(
                   means          = wmeans,
                   weights        = tweights,
                   unbiased       = if (method != "iterative") b,
                   iterative      = if (method == "iterative") b,
                   cred           = cred,
                   nodes          = nnodes,
                   classification = classification[, -1L],
                   ordering       = fnodes
                   ),
              class = "hierarc",
              model = "hierarchical"
              )
}
myCorr <-
structure(c(1, 0.288675134594813, 0.288675134594813, 1), .Dim = c(2L, 
2L))
n <-
c(6, 6, 3, 5, 7, 4, 3, 2, 2, 4)
nexen <-
function (pinCount=10,pinRadius=2,pinionRadius=16,distPerRev=100)
{
  tmp = list(N=pinCount, r=pinRadius, R=pinionRadius, D=distPerRev)
  class(tmp)<-"NexenPinion"
  tmp
}
op <-
structure(list(bg = "transparent"), .Names = "bg")
p0 <-
c(0, 0)
p1 <-
c(0.707106781186548, 0.707106781186547)
peak <-
function (x,y, radius=1, n=100) 
{
  theta = pi*(0:n)/n
  X = x + radius*cos(theta)
  Y = y + radius*sin(theta)
  lines(X,Y)
}
plot.NexenPinion <-
function (x,...)
{
  tmp=x$R+3*x$r
  plot(c(-tmp,tmp),c(-tmp,tmp), type ="n")
  circle(0,0,radius=x$r)
  rho=0:(x$N-1)
  
}
plotMarket <-
function (n,capital,sigma,img,base="C:\\Junk") 
{
	position = capital + cumsum(rnorm(n,0,sigma))
	jpeg(file=paste(base,"\\",img,".jpg", sep=""))
	plot(position, type ="l")
	dev.off()
}
plotOp <-
function (n, lambda, mu, sigma) 
{
	Events = rexp(ceiling(n*lambda +3*sqrt(n*lambda)), lambda)
	Events = cumsum(Events[cumsum(Events) < n])
	Losses = rlnorm(length(Events), 7, 1.5)
	plot(Events, cumsum(Losses), type = "s")
#	list(Events = Events, Losses = Losses)
}
Poisson <-
function (params) 
{
    lambda = params[1]
    
    tmp <- list(
                Model = "Poisson"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dpois(x,lambda)
                },
                Cdf = function(x)
                {
                    ppois(x,lambda)
                },
                Quantile = function(p)
                {
                    qpois(p,lambda)
                },
                Roll = function(n)
                {
                    rpois(n,lambda)
                },
                Mean<-params[1]
                ,
                Variance<- params[1]^2
    )
    
    class(tmp)="RandomVar"
    tmp
}
predict.bstraub <-
function(object, levels = NULL, newdata, ...)
    object$means[[1]] + object$cred * (object$means[[2]] - object$means[[1]])
predict.cm <-
function(object, levels = NULL, newdata, ...)
{
    ## Convert the character 'levels' argument into numeric and pass
    ## to next method.
    level.names <- names(object$nodes)

    levels <-
        if (is.null(levels))
            seq_along(level.names)
        else
            pmatch(levels, level.names)
    if (any(is.na(levels)))
        stop("invalid level name")
    NextMethod()
}
predict.hierarc <-
function(
                            object, 
                            levels = NULL, 
                            newdata, 
                            ...
                            )
{
    ## The credibility premium of a node at one level is equal to
    ##
    ##   p + z * (m - p)
    ##
    ## where 'p' is the credibility premium of the level above (or the
    ## collective premium for the portfolio), 'z' is the credibility
    ## factor of the node, and 'm' is the weighted average of the
    ## node.
    fnodes <- object$ordering
    cred <- object$cred
    means <- object$means
    nlevels <- length(object$nodes)
    level.names <- names(object$nodes)

    if (is.null(levels))
        levels <- seq_len(nlevels)
    if (any(is.na(levels)) || !is.numeric(levels))
        stop("invalid level number")
    n <- max(levels)

    res <- vector("list", n)

    ## First level credibility premiums
    res[[1L]] <- means[[1L]] + cred[[1L]] * (means[[2L]] - means[[1L]])

    for (i in seq(2, length.out = n - 1))
    {
        p <- res[[i - 1]][fnodes[[i]]]
        res[[i]] <- p + cred[[i]] * (means[[i + 1]] - p)
    }

    structure(res[levels], names = level.names[levels], ...)
}
print.cm <-
function(x, ...)
{
    nlevels <- length(x$nodes)
    level.names <- names(x$nodes)
    b <- if (is.null(x$iterative)) x$unbiased else x$iterative

    cat("Call:\n")
    print(attr(x, "call"))
    cat("\n")

    cat("Structure Parameters Estimators\n\n")
    cat("  Collective premium:", x$means[[1]], "\n")
    for (i in seq.int(nlevels))
    {
        if (i == 1)
        {
            ## Treat the Hachemeister and no regression models
            ## separately since for the former the variance components
            ## vector is a list, with the first element a matrix.
            s <- paste("  Between", level.names[i], "variance: ", sep = " ")
            if (attr(x, "model") == "regression")
            {
                m <- b[[1]]
                dimnames(m) <- list(c(s, rep("", nrow(m) - 1)), rep("", ncol(m)))
                print(m)
            }
            else
                cat("\n", s, b[i], "\n", sep = "")
        }
        else
            cat("  Within ", level.names[i - 1],
                "/Between ", level.names[i], " variance: ",
                b[i], "\n", sep = "")
    }
    cat("  Within", level.names[nlevels], "variance:",
        b[[nlevels + 1]], "\n", fill = TRUE)
    invisible(x)
}
print.NexenPinion <-
function (x,...) 
{
  cat("NexenPinion\n")
  cat("\tN : ", x$N, "\n")
  cat("\tR : ", x$R, "\n")
  cat("\tr : ", x$r, "\n")
  cat("\tD : ", x$D, "\n")
  cat("\tChord : ", 2*x$R*sin(pi/x$N), "\n")
  
}
print.RandomVar <-
function (x, ..., digits = NULL, quote = FALSE, right = TRUE, 
	row.names = TRUE) 
{
    l<-length(x$Parameters)
	cat(x$Model,"(", x$Parameters[1],")\n")
	invisible(x)
}
print.summary.cm <-
function(x, ...)
{
    nlevels <- length(x$nodes)
    level.names <- names(x$nodes)
    NextMethod()                        # print.cm()
    cat("Detailed premiums\n\n")
    for (i in seq.int(nlevels))
    {
        cat("  Level:", level.names[i], "\n")
        level.id <- match(level.names[i], colnames(x$classification))
        levs <- x$classification[, seq.int(level.id), drop = FALSE]
        m <- duplicated(levs)

        ## Treat the Hachemeister and no regression models
        ## separately.
        if (attr(x, "model") == "regression")
        {
            y <- cbind(" ",
                       as.vector(format(x$means[[i + 1]], ...)),
                       as.vector(apply(format(x$cred[[i]], ...), c(1, 3),
                                       paste, collapse = " ")),
                       as.vector(format(sapply(x$adj.models, coef), ...)),
                       " ")
            y[seq(1, nrow(y), dim(x$cred[[i]])[1]), c(1, 5)] <-
                c(levs[!m, , drop = FALSE], format(x$premiums[[i]], ...))
            colnames(y) <- c(colnames(levs),
                             "Indiv. coef.", "Credibility matrix",
                             "Adj. coef.", "Cred. premium")
        }
        else
        {
            y <- cbind(as.matrix(levs[!m, , drop = FALSE]),
                       format(x$means[[i + 1]], ...),
                       format(x$weights[[i + 1]], ...),
                       format(x$cred[[i]], ...),
                       format(x$premiums[[i]], ...))
            colnames(y) <- c(colnames(levs),
                             "Indiv. mean", "Weight",
                             "Cred. factor", "Cred. premium")
        }
        rownames(y) <- rep("   ", nrow(y))
        print(y, quote = FALSE, right = FALSE, ...)
        cat("\n")
    }
    invisible(x)
}
Sample <-
function (x, size, replace = FALSE, prob = NULL) 
{
    if (length(x) == 1L && is.numeric(x) && x >= 1) {
        if (missing(size)) 
            size <- x
        sample.int(x, size, replace, prob)
    }
    else {
        if (missing(size)) 
            size <- length(x)
        x[sample.int(length(x), size, replace, prob)]
    }
}
summary.cm <-
function(object, levels = NULL, newdata, ...)
{
    level.names <- names(object$nodes)

    if (length(level.names) == 1)
    {
        ## Single level cases (Buhlmann-Straub and Hachemeister):
        ## return the object with the following modifications: put
        ## credibility factors into a list and add a list of the
        ## credibility premiums.
        object$premiums <- list(predict(object, newdata = newdata))
        object$cred <- list(object$cred)
        class(object) = c("summary.cm", class(object))
    }
    else
    {
        ## Multi-level case (hierarchical): select result of the
        ## appropriate level(s).
        plevs <-
            if (is.null(levels))
                seq_along(level.names)
            else
                pmatch(levels, level.names)
        if (any(is.na(plevs)))
            stop("invalid level name")

        object$premiums <- predict(object, levels) # new element
        object$means <- object$means[c(1, plevs + 1)]
        object$weights <- object$weights[c(1, plevs + 1)]
        object$unbiased <- object$unbiased[sort(unique(c(plevs, plevs + 1)))]
        object$iterative <- object$iterative[sort(unique(c(plevs, plevs + 1)))]
        object$cred <- object$cred[plevs]
        object$classification <- object$classification[, seq.int(max(plevs)), drop = FALSE]
        object$nodes <- object$nodes[plevs]
        class(object) <- c("summary.cm", class(object))
    }
    object
}
tmp <-
structure(list(means = structure(list(portfolio = 1683.71343704728, 
    state = c(2060.92139184264, 1511.22412666499, 1805.84273753185, 
    1352.97591522158, 1599.82860703406)), .Names = c("portfolio", 
"state")), weights = structure(list(portfolio = 4.4975513339148, 
    state = c(100155, 19895, 13735, 4152, 36110)), .Names = c("portfolio", 
"state")), unbiased = structure(c(89638.7262327551, 139120025.925285
), .Names = c("portfolio", "state")), cred = c(0.984740401933337, 
0.927635217974918, 0.898475355206511, 0.727909209400669, 0.958791149399359
), nodes = structure(list(state = 5L), .Names = "state"), classification = structure(c(1, 
2, 3, 4, 5), .Dim = c(5L, 1L), .Dimnames = list(NULL, "state")), 
    ordering = structure(list(state = 1:5), .Names = "state")), .Names = c("means", 
"weights", "unbiased", "cred", "nodes", "classification", "ordering"
), class = c("cm", "bstraub"), model = "Buhlmann-Straub", call = quote(cm(formula = ~state, 
    data = hachemeister, ratios = ratio.1:ratio.12, weights = weight.1:weight.12)))
valley <-
function (x,y, radius=1, n=100) 
{
  theta = pi +pi*(0:n)/n
  X = x + radius*cos(theta)
  Y = y + radius*sin(theta)
  lines(X,Y)
}
Weibull <-
function (params) 
{
    rate = 1/params[2]
    
    tmp <- list(
                Model = "Weibull"
                ,
                Parameters = params
                ,
                Pdf = function(x)
                {
                    dweibull(x, params[1], rate)
                },
                Cdf = function(x)
                {
                    pweibull(x, params[1], rate)
                },
                Quantile = function(p)
                {
                    qweibull(p, params[1], rate)
                },
                Roll = function(n)
                {
                    rweibull(n, params[1], rate)
                },
                Mean<-params[1]*params[2]
                ,
                Variance<- params[1]^2
    )
    class(tmp)="RandomVar"
    tmp
    
    
}
x <-
c(0.160950171062723, 0.308113463688642, 0.043683887924999, 0.504859755048528, 
0.274851986439899, 0.869402915006503, 0.199820748763159, 0.40289527643472, 
0.339113015914336, 0.377146068494767, 0.409665465354919, 0.889124211622402, 
0.82600621599704, 0.862781709525734, 0.907119061797857, 0.412157459883019, 
0.0405022157356143, 0.474472916452214, 0.487940322142094, 0.223449340090156, 
0.759951232001185, 0.385277701774612, 0.356552734272555, 0.743010280653834, 
0.158097007311881, 0.725832611322403, 0.285843992140144, 0.3273886279203, 
0.831911267945543, 0.529661753214896)
